name: "Aggregate CodeQL Results"
description: "Download and combine CodeQL results artifacts, then optionally post as PR comment"

inputs:
  post-pr-comment:
    description: 'Whether to post combined results as a PR comment'
    required: false
    type: boolean
    default: true
  github-token:
    description: 'GitHub token for posting comments'
    required: true
    type: string

runs:
  using: "composite"
  steps:
      - name: Download all CodeQL results
        id: download-results
        uses: actions/download-artifact@v6
        with:
          path: ./codeql-aggregate

      - name: Combine SARIF results
        id: combine-sarif-results
        run: |
          mkdir -p ./codeql-merged
          # Merge all SARIF files into one combined SARIF file
          jq -s 'reduce .[] as $item ({}; .runs += $item.runs)' ./codeql-aggregate/**/*.sarif > ./codeql-merged/combined-codeql-results.sarif || true

      - name: Post combined results as PR comment
        id: post-pr-comment
        if: ${{ github.event_name == 'pull_request' && inputs.post_pr_comment == true }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ inputs.github-token }}
          script: |
            const fs = require('fs');
            const maxLength = 50000;
            let results = '';

            try {
              // Read the combined SARIF file
              const sarifData = fs.readFileSync('./codeql-merged/combined-codeql-results.sarif', 'utf8');
              const sarifJson = JSON.parse(sarifData);
              // Extracting just the rule messages (simplified example, you can extract more info)
              results = sarifJson.runs.flatMap(run => 
                run.results.map(result => `${result.ruleId}: ${result.message.text}`)
              ).join("\n");
            } catch (err) {
              results = 'No CodeQL results found.';
            }

            // Truncate the result if it's too long
            if (results.length > maxLength) {
              results = results.slice(0, maxLength) + "\n...[truncated]";
            }

            // Post the comment on the PR
            const commentBody = `### CodeQL Scan Results (all languages)\n\`\`\`\n${results}\n\`\`\``;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: commentBody
            });